

\paragraph{A tighter correspondence to operational semantics?}

From computational adequacy, Theorem~\ref{thm:adequacy} we can easily state
the following theorem: 
\begin{corollary} Assume that $e$ and $\Ct$ contain no term variables and 
assume that $\ctrans{}{\cdot}{e \in \{x \mid e_p\}} = \formula{\phi}$. It is the case 
that $\langle D_\infty,{\cal I}\rangle \models \phi$ if and only iff either
$P \not|- e \Downarrow$ or $P \not|- e_p[e/x] \Downarrow$ or $P |- e_p[e/x] \Downarrow \True$. \end{corollary}

Hence, the operational and the denotational semantics of base predicate contracts coincide.
It is interesting to see whether our shift to denotational semantics -- at least compared
to previous work on checking Haskell contracts~\cite{xu} -- has any other consequences? Does
the above correspondence break for higher-order contracts?

The answer is that this precise correspondence indeed breaks. 
Recall that the operational definition of contract satisfaction for a contract $\Ct_1 -> \Ct_2$ is the following: 
\[\begin{array}{l} 
   e \in (x{:}\Ct_1) -> \Ct_2 \text{iff} \\
   \text{for all } e' \text{ such that } (e' \in \Ct_1) \text{ it is } e\;e' \in \Ct_2[e'/x]
\end{array}\] 
The denotational one requires that for all denotations $d'$ such that
$d' \in \dbrace{\Ct_1}$ it is the case that 
$\dapp(\dbrace{e},d') \in \dbrace{\Ct_2}_{x |->d'}$. 
 
Alas there are {\em more} denotations than images of terms in $D_{\infty}$ and the correspondence breaks. Consider the program:
\[\begin{array}{lcl}
f_\omega = f_\omega \\
f (b{:}Bool) (h{:}Bool->Bool->Bool) = \\ 
\begin{array}{lll}
  &     & \quad @if@\;(h\;True\;b)\;\&\&\;(h\;b\;True)\;\&\& \\ 
  &     & \quad\qquad\qquad not\;(h\;False\;False)\;@then@ \\
  &     & \quad\quad @if@\;(h\;True\;f_\omega)\;\&\&\;(h\;f_\omega\;True)\;@then@\;@BAD@ \\
  &     & \quad\quad @else@\;True \\
  &     & \quad @else@\;True
\end{array}
\end{array}\]
Also consider now the candidate contract for $f$ below (and assume that we have managed to equate the denotational and the operational definitions of crash-freedom):
\[ \CF -> (\CF -> \CF -> \CF) -> \CF \]
Operationally we may assume a crash-free boolean as well as a function $h$ which is 
$\CF -> \CF -> \CF$. The first conditional ensures that the function behaves like an ``or'' function or 
diverges. However if we pass the first conditional, 
the second conditional will always diverge and hence the contract will be satisfied. 

However, denotationally it is possible to have a {\em monotone} function $por$ defined as follows (for convenience, 
we are using pattern matching notation instead of our language of domain theory combinators):
\[\begin{array}{lcl}
  por\;\bot\;\bot & = & \bot \\ 
  por\;\bot\;True & = & True \\
  por\;True\;\bot & = & True \\ 
  por\;False\;False & = & False
\end{array}\] 
The rest of the equations (for @BAD@ arguments) are induced by monotonicity and we may pick whatever boolean value 
we like when both arguments are @BAD@. 

Now, this is denotationally a $\CF -> \CF -> \CF$ function, and it will pass the first conditional, but it will
also pass the second conditional, yielding @BAD@. Hence denotationally the contract for $f$ {\em does not hold}.

So we have a concrete case where an expression may satisfy its
contract operationally but not denotationally, because there are more
tests than programs in the denotational world. Due to contra-variance
we expect that the other inclusion will fail too. This is not a catastrophic 
problem for our reasoning principles about programs -- after all the two 
definitions will mostly coincide and they will precisely coincide in the base case. 
In the end of the day we will be interested on whether a program crashes or not and 
if we have proven that it is crash-free denotationally, it is definitely crash-free in 
any operationally reasonable term. 

Finally, was it possible to define an operational model for our FOL theory that interpreted
equality as contextual equivalence? Probably this could be made to work, although we believe
that the formal clutter from syntactic manipulation of terms could be worse than the current
denotational approach. 

